# Discovery Node Changes - July 29, 2025

## Overview
Updated Discovery Node to return organization data in CMP brand-registry format with proper URN generation and feed URL management.

## Key Changes

### 1. CMP Brand-Registry Format Implementation
- **File**: `app/utils/formatters.py`
- Added `format_organization_registry_response()` function to format organization responses in CMP brand-registry format
- Changed `@id` fields to `identifier` objects with `propertyID` and `value` fields
- Added `cmp:productFeed` field with DataFeed type containing the feed URL
- Removed organization wrapper from responses per user requirements

### 2. Static URN Namespace
- **File**: `app/core/urn_generator.py`
- Added static `CMP_NAMESPACE = uuid.UUID("4c2d9653-e971-4093-8d5b-82da447c2e85")`
- Updated all URN generation functions to use the static namespace for consistent URN generation
- This ensures the same input always generates the same URN

### 3. Organization API Updates
- **File**: `app/api/routes/organization.py`
- Fixed category handling to maintain arrays instead of converting to strings
- Updated to use shop domain for URN generation to ensure consistency
- Fixed brand relationship loading issues
- Added logic to handle existing organizations (update instead of create)
- Added brand update/creation logic when organization already exists

### 4. Response Format Changes
- Removed organization wrapper from both create and get endpoints
- Categories are now returned as arrays: `["books", "gifts"]` instead of `"{books,gifts}"`
- Feed URLs use subdomain format: `https://{subdomain}/feed/feed.json`

## API Response Example
```json
{
  "@context": {
    "schema": "https://schema.org",
    "cmp": "https://cmp.commercemesh.com/ns#"
  },
  "@type": "Organization",
  "identifier": {
    "@type": "PropertyValue",
    "propertyID": "cmp:orgId",
    "value": "urn:cmp:org:6251d576-2370-5373-a772-5d8d5c194ab1"
  },
  "name": "Overway, Inc",
  "url": "https://overway.ai",
  "logo": "https://overway.ai/logo.png",
  "description": "desc",
  "category": ["books", "gifts"],
  "cmp:productFeed": {
    "@type": "DataFeed",
    "url": "https://overway-inc-1/feed/feed.json"
  },
  "brand": {
    "@type": "Brand",
    "identifier": {
      "@type": "PropertyValue",
      "propertyID": "cmp:brandId",
      "value": "urn:cmp:org:6251d576-2370-5373-a772-5d8d5c194ab1:brand:77b7d210-1cea-5c2b-9d2d-18c48f6cb11c"
    },
    "name": "Overway",
    "url": "https://overway.ai",
    "logo": "https://overway.ai/logo.png"
  }
}
```

## Breaking Changes
- Organization responses no longer wrapped in `organization` object
- URN format changed to use identifier objects instead of direct `@id` fields
- Categories must be arrays, not strings